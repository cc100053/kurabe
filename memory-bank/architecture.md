Kurabe architecture snapshot

- Entry & theming: `lib/main.dart` loads `.env`, initializes Supabase (PKCE auth), locks portrait orientation, and builds the Noto Sans JP themed design system via `KurabeColors`. `WelcomeScreen` gates initial auth, `MainScaffold` hosts the primary tabs.
- Navigation shell: `lib/screens/main_scaffold.dart` renders a 2-1-2 bottom nav (Timeline, Catalog, Shopping List, Profile) with a center-notched FAB that opens `AddEditScreen`. Tabs are kept alive via `IndexedStack`.
- State management: Mix of Riverpod (`subscriptionProvider` for paywall status) and a legacy `ChangeNotifier` (`AppState`) for local price history backed by SQLite. Supabase auth/session state is read directly where needed.
- Data layer: Price flow now uses `PriceRepository` + `PriceRemoteDataSource` + `PriceRecordMapper`/`PriceCalculator` to wrap Supabase CRUD, storage uploads to `price_tags`, community search/count RPCs, category fetch, and nearby cheapest checks with `user_id`/`tax_rate` fallbacks. `ShoppingListService` reads/writes `shopping_list_items` for both anonymous and logged-in users. `SubscriptionService` handles RevenueCat configuration, purchases, Customer Center, and syncing `profiles.is_pro`. `GeminiService` orchestrates OCR of price tags. `GooglePlacesService` + `LocationService` fetch and cache nearby stores, autocomplete, and place details. `DatabaseHelper` + `PriceLogic` provide local SQLite storage and price/tax calculation utilities.
- Domain models: Plain models in `lib/models/` (`price_record.dart`, `product.dart`, `shop.dart`, `shopping_list_item.dart`) map to local SQLite tables and Supabase rows, with helpers for serialization and unit/tax computation.
- Screens: `AddEditScreen` drives the capture/edit flow (smart camera, Gemini parsing, discount/original price, category picker, unit price, best-price insight, Supabase save). `SmartCameraScreen` provides a guided capture overlay. `TimelineTab` streams `price_records` for the current user. `CatalogTab` shows categories and community vs. mine toggles, `CategoryDetailScreen` groups nearby records with confirmation counts, `ProductDetailScreen` shows record detail and cheapest/community chips, `ShoppingListScreen` manages list CRUD with guest prompts, `ProfileTab` shows stats/settings and entry points to subscriptions, and `PaywallScreen` exposes purchase/restore/paywall/Customer Center actions.
- Shared UI: Widgets under `lib/widgets/` (`community_product_tile.dart`, `product_detail_sheet.dart`, `shopping_card.dart`, `camera_overlay_guide.dart`) encapsulate reusable tiles/sheets with the premium visual system. Constants under `lib/constants/` define category lists/visuals and auth provider identifiers.
- Backend schema (Supabase): Primary table `price_records` (id, product_name, price, quantity, original_price, price_type, discount_type/value, tax_rate, is_tax_included, shop_name/lat/lng, category_tag, image_url, is_best_price, user_id, created_at) with trigram/created_at/location/user/category indexes and RLS (insert all; select own or Pro; update/delete own). `profiles` table stores `is_pro` flag per auth user. `shopping_list_items` (id, user_id, title, is_done, created_at) uses user-scoped RLS for guests and logged-in users. Storage bucket `price_tags` allows public upload/read. RPCs include `get_nearby_cheapest`, `search_community_prices`, `count_nearby_community_prices`, `search_products_fuzzy`, and `get_nearby_records_by_category`.
- External services: RevenueCat handles entitlement `カイログ Pro` with package IDs like `monthly`/`quarterly`/`annual`; Google Places provides nearby/Autocomplete; Gemini 1.5 Flash powers OCR parsing; Geolocator supplies coordinates.
